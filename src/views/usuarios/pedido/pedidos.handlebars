{{>usuario/_top-css}}

<div class="container-fluid bg-soft">
<div class="row">
<div class="col-12">
{{>usuario/_menu}}

<main class="content">
    
    <div class="">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
                <li class="breadcrumb-item"><a href="/dashboard"><span class="fas fa-home"></span></a></li>
            </ol>
        </nav>
    </div>

    <div>
        <button type="button" class="btn btn-primary btn-sm mb-4">+ Adicionar</button>
        <button class="btn btn-{{#if filtroExist}}danger{{else}}white{{/if}} btn-sm mb-4 float-end" data-bs-toggle="collapse" data-bs-target="#collapseExample"> <i class="fas fa-filter"></i> </button>
        

        <div class="collapse mb-4" id="collapseExample">
            <div class="card card-body">
                <form method="get" id="form-filtro-1">
                    <div class="row">
                        <div class="col-sm-4 mt-2">
                            <label for="filtro-conteudo">Nome Cliente / Telefone</label>
                            <input type="text" class="form-control" name="conteudo" id="filtro-conteudo" value="{{conteudo}}">
                            <span style="font-size: x-small;">* Se for telefone, digite apenas o número. Ex: 99988-1623</span>
                        </div>
                        <div class="col-sm-4 mt-2">
                            <label for="filtro-dataInicio">Data Inicio</label>
                            <input type="datetime-local" class="form-control" name="dataInicio" id="filtro-dataInicio" value="{{dataInicio}}" required>
                        </div>
                        <div class="col-sm-4 mt-2">
                            <label for="filtro-dataFim">Data Fim</label>
                            <input type="datetime-local" class="form-control" name="dataFim" id="filtro-dataFim" value="{{dataFim}}" required>
                        </div>
                        <hr class="mt-4">
                        <div class="col-sm-3 mt-2">
                            <input name="pagamentoTipo" class="" id="filtro-pedido-pagamento-tipo" placeholder="Tipo pagamento" value="{{pagamentoTipo}}">
                        </div>
                        <div class="col-sm-3 mt-2">
                            <input name="pagamentoForma" class="" id="filtro-pedido-pagamento-forma" placeholder="Forma pagamento" value="{{pagamentoForma}}">
                        </div>
                        <div class="col-sm-3 mt-2">
                            <input name="situacao" class="" id="filtro-pedido-situacao" placeholder="Situacao" value="{{situacao}}">
                        </div>
                        <div class="col-sm-3 mt-2">
                            <input name="entregador" class="" id="filtro-pedido-entregador" placeholder="Entregador" value="{{entregador}}">
                        </div>
                        <div class="col-sm-3 mt-2">
                            <input name="tipoEntrega" class="" id="filtro-pedido-tipoEntrega"  placeholder="Tipo entrega" value="{{tipoEntrega}}">
                        </div>
                        <div class="col-sm-3 mt-2">
                            <input name="pagamento" class="" id="filtro-pedido-pagamento"  placeholder="Pagamento" value="{{pagamento}}">
                        </div>
                        
                    </div>

                    <input type="text" name="limit" id="filtro-pedido-limit" value="{{pagination.limitPage}}" hidden readonly>

                    <button class="btn btn-dark btn-sm mt-2" type="submit">Filtrar</button>
                    {{#if filtroExist}}<a href="/produto/produtos" class="btn btn-white btn-sm mt-2 text-danger">Limpar filtro</a>{{else}}{{/if}}
                </form>

                <script>

                    let tagifyFiltroPagamentoTipo = new Tagify(document.querySelector('input[id=filtro-pedido-pagamento-tipo]'), {
                        whitelist: ['mercadoPago', 'pagarRecebimento'],
                        editTags: false,
                        dropdown: {
                            maxItems: Infinity,
                            enabled : 0 // always opens dropdown when input gets focus
                        },
                    })

                    let tagifyFiltroPagamentoForma = new Tagify(document.querySelector('input[id=filtro-pedido-pagamento-forma]'), {
                        whitelist: ['dinheiro', 'pix', 'cartaoDebito', 'cartaoCredito'],
                        editTags: false,
                        dropdown: {
                            maxItems: Infinity,
                            enabled : 0 // always opens dropdown when input gets focus
                        },
                    })

                    let tagifyFiltroSituacao = new Tagify(document.querySelector('input[id=filtro-pedido-situacao]'), {
                        whitelist: ['Cancelado', 'Finalizado', 'Aguardando', 'Produção', 'Concluido', 'Entrega'],
                        editTags: false,
                        dropdown: {
                            maxItems: Infinity,
                            enabled : 0 // always opens dropdown when input gets focus
                        },
                    })

                    let tagifyFiltroTipoEntrega = new Tagify(document.querySelector('input[id=filtro-pedido-tipoEntrega]'), {
                        whitelist: ['retirarEstabelecimento', 'entrega'],
                        editTags: false,
                        dropdown: {
                            maxItems: Infinity,
                            enabled : 0 // always opens dropdown when input gets focus
                        },
                    })

                    let tagifyFiltroEntregador = new Tagify(document.querySelector('input[id=filtro-pedido-entregador]'), {
                        whitelist: [ {{#each entregadores}} {'idEntregador': '{{_id}}', value: '{{nome}}' },  {{/each}} ],
                        editTags: false,
                        dropdown: {
                            maxItems: Infinity,
                            enabled : 0 // always opens dropdown when input gets focus
                        },
                    })

                    let tagifyFiltroPagamento = new Tagify(document.querySelector('input[id=filtro-pedido-pagamento]'), {
                        whitelist: ['Pago', 'Cancelado', 'Aguardando'],
                        editTags: false,
                        dropdown: {
                            maxItems: Infinity,
                            enabled : 0 // always opens dropdown when input gets focus
                        },
                    })

                </script>
            </div>
        </div>
        
    </div>
    
    <div class="card border-light shadow-sm mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-centered table-nowrap mb-0 rounded">
                    <thead class="thead-light">
                        <tr>
                            <th class="border-0">#</th>
                            <th class="border-0">Nome Cliente</th>
                            <th class="border-0">Telefone Cliente</th>
                            <th class="border-0">Data</th>
                            <th class="border-0">Valor Total</th>
                            <th class="border-0">Tipo Pagamento</th>
                            <th class="border-0">Tipo Entrega</th>
                            <th class="border-0">Situação</th>
                            <th class="border-0">Pagamento</th>
                            <th>Estabelecimento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each pedidos}}
                        <!-- Item -->
                        <tr>
                            <td>
                                <button class="btn btn-white btn-sm" type="button" id="dropdown-options-{{_id}}" data-bs-toggle="dropdown" >
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu" style="min-width: auto" aria-labelledby="dropdown-options-{{_id}}">
                                    <li class="mx-3"><a class="btn btn-sm" href="/pedido/pedido?pedido='{{_id}}'"><i class="fas fa-eye"></i> Ver</a></li>
                                    
                                    <form action="/pedido/edit-pedidos-situacao" method="post">
                                        <input type="text" name="idPedido" value="{{_id}}" hidden readonly>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="mx-3"><button class="btn btn-sm" name="situacao" value="waiting"><i class="fas fa-clock"></i> Aguardando</button></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="mx-3"><button class="btn btn-sm" name="situacao" value="production"><i class="fas fa-spinner text-warning"></i> Produção</button></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="mx-3"><button class="btn btn-sm" name="situacao" value="concluded"><i class="fas fa-check text-success"></i> Concluido</button></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="mx-3"><button class="btn btn-sm" name="situacao" value="delivery"><i class="fas fa-truck"></i> Entrega</button></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="mx-3"><button class="btn btn-sm" name="situacao" value="canceled"><i class="fas fa-times-circle text-danger"></i> Cancelar</button></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li class="mx-3"><button class="btn btn-sm" name="situacao" value="finished"><i class="fas fa-check-circle text-success"></i> Finalizar</button></li>
                                    </form>
                                </ul>
                            </td>
                            <td><span class="text-primary font-weight-bold">{{infoEntrega.nomeCliente}}</span> </td>
                            <td>
                                <span class="text-primary font-weight-bold">{{infoEntrega.telefone}} <i class="fab fa-whatsapp text-success" data-bs-toggle="modal" data-bs-target="#modal-send-msg-WhatsApp" data-bs-telefone="{{infoEntrega.telefone}}" data-bs-nome="{{infoEntrega.nomeCliente}}" style="cursor: pointer;"></i> </span> 
                            </td>
                            <td>{{dataFormatTimeZone ../usuarioLogado.timeZone dataCriacao "DD/MM/YYYY HH:mm"}}</td>
                            <td class="valorFormatar">{{valorTotal}}</td>
                            <td>{{pagamento.tipo}}
                                {{#if pagamento.forma}}
                                    <button class="btn btn-white btn-sm" type="button" id="dropdown-pagamento-{{_id}}" data-bs-toggle="dropdown" >
                                        +
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdown-pagamento-{{_id}}">
                                        <div class="m-2">Forma: {{pagamento.forma}}</div>
                                        {{#if pagamento.trocoPara}}
                                            <div class="m-2">Troco para: <span class="valorFormatar">{{pagamento.trocoPara}}</span></div>
                                        {{/if}}
                                    </ul>
                                {{/if}}
                            </td>
                            <td>{{tipoEntrega}}</td>
                            <td class="format-pedido-situacao">{{situacao}}</td>
                            <td>
                                {{#if pagamento.pago}}
                                    <i class="fas fa-check-circle text-success"></i> PAGO
                                {{else}}
                                    {{#if infoTransacao.pedidoPago}}
                                        <i class="fas fa-check-circle text-success"></i> PAGO
                                    {{else}}
                                        {{#if infoTransacao.pedidoCancelado}}
                                            <i class="fas fa-times-circle text-danger"></i> CANCELADO
                                        {{else}}
                                            <i class="fas fa-clock"></i> Aguardando
                                        {{/if}}
                                    {{/if}}
                                {{/if}}
                            </td>
                            <td>{{idEstabelecimento.nome}}</td>
                        </tr>
                        <!-- End of Item -->
                        {{/each}}

                    </tbody>
                </table>
            </div>
            <div class="mt-4">

                <div class="dropdown">
                <button class="btn btn-white btn-sm float-end" type="button" id="dropdown-limit-list" data-bs-toggle="dropdown">
                    <i class="fas fa-bars"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdown-limit-list">
                    <div class="text-center">Registro por página</div>
                    <div>
                        <button class="buttonClickLimit btn btn-light btn-sm ml-1 click-paginate" value="10">10</button>
                        <button class="buttonClickLimit btn btn-light btn-sm ml-1 click-paginate" value="20">20</button>
                        <button class="buttonClickLimit btn btn-light btn-sm ml-1 click-paginate" value="50">50</button>
                        <button class="buttonClickLimit btn btn-light btn-sm ml-1 click-paginate" value="100">100</button>
                        <button class="buttonClickLimit btn btn-light btn-sm ml-1 mr-1 click-paginate" value="200">200</button>
                    </div>
                </ul>
                </div>
                <span class="float-end mt-1 mr-4">{{pagination.startPage}} a {{pagination.endPage}} de {{pagination.totalPage}}</span>

                <nav class="page-pagination">
                    <ul class="pagination pagination-sm">
                    {{#paginate pagination type="first"}}
                        <li {{#if disabled}}class="page-item"{{/if}}><a class="page-link click-paginate" href="?paginate={{n}}">«</a></li>
                    {{/paginate}}
                    
                    {{#paginate pagination type="middle" limit="5"}}
                        <li {{#if active}}class="page-item active current" {{/if}}><a class="page-link click-paginate" href="?paginate={{n}}">{{n}}</a></li>
                    {{/paginate}}
                    
                    {{#paginate pagination type="last"}}
                        <li {{#if disabled}}class="page-item"{{/if}}><a class="page-link click-paginate" href="?paginate={{n}}">»</a></li>
                    {{/paginate}}
                    </ul>
                </nav>

                <script>
                    let filtro1 = $('#form-filtro-1').serialize()
                    let limit = "limit="+10

                    $('.click-paginate').click(function (e) {
                        event.preventDefault()
                        if(e.target.classList[0] == "buttonClickLimit"){
                            $('#filtro-pedido-limit').val(e.target.value)
                            $('#form-filtro-1').submit()
                        }else{
                            $(this).attr('href').slice(1)
                            paginate = $(this).attr('href').slice(1);
                            location.href = `?${paginate}&${filtro1}` ;
                        }
                    });
                </script>

            </div>

            <!-- Modal Envio WhatsApp -->
            <div class="modal fade" id="modal-send-msg-WhatsApp" tabindex="-1" aria-labelledby="modal-send-msg-WhatsAppLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="h6 modal-title">Enviar Mensagem WhatsApp</h2>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Nome: <span id="send-whatsapp-nome"></span></p>
                        <p>Telefone: <span id="send-whatsapp-telefone"></span></p>
                        <textarea id="send-whatsapp-msg" class="form-control" rows="4"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-primary" id="button-send-whatsapp-msg">Enviar</button>
                        <button type="button" class="btn btn-link text-danger ml-auto" data-bs-dismiss="modal">Fechar</button>
                    </div>
                    </div>
                </div>
            </div>

            <script>
                var modalSendMsgWhatsApp = document.getElementById('modal-send-msg-WhatsApp')
                modalSendMsgWhatsApp.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget
                    $('#send-whatsapp-nome').text(button.getAttribute('data-bs-nome'))
                    $('#send-whatsapp-telefone').text(button.getAttribute('data-bs-telefone'))
                    $('#send-whatsapp-msg').val('')
                })

                $('#button-send-whatsapp-msg').click(() => {
                    let number = $('#send-whatsapp-telefone').text()
                    let text = $('#send-whatsapp-msg').val()
                    window.open(`
                        https://wa.me/55${number.replace(/[^0-9]/g,'')}?text=${text}
                    `, '_blank');
                    
                    $('#modal-send-msg-WhatsApp').modal('hide')
                })
            </script>



        </div>
    </div>

</main>

</div>
</div>
</div>

<script>
    $(".valorFormatar").each(function (item) {
        let textFormat = $(this).text()
        $(this).html(new Intl.NumberFormat('pt-br', { style: 'currency', currency: 'BRL' }).format(textFormat));
    })

    $(".format-pedido-situacao").each(function (item) {
        let textFormat = $(this).text()
        switch (textFormat) {
            case 'canceled':
                $(this).html('<i class="fas fa-times-circle text-danger"></i> Cancelado')
                break;
            case 'waiting':
                $(this).html('<i class="fas fa-clock"></i> Aguardando')
                break;
            case 'production':
                $(this).html('<i class="fas fa-spinner text-warning"></i> Produção')
                break;
            case 'concluded':
                $(this).html('<i class="fas fa-check text-success"></i> Concluido')
                break;
            case 'delivery':
                $(this).html('<i class="fas fa-truck"></i> Entrega')
                break;
            case 'finished':
                $(this).html('<i class="fas fa-check-circle text-success"></i> Finalizado')
                break;
            default:
                $(this).html('err')
        }
    })
</script>

{{>usuario/_rodape}}

{{>_msg}}
